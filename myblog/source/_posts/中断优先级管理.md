---
title: 中断优先级管理
date: 2020-07-26 22:35:45
tags:
- stm32
categories:
- 单片机
- stm32

---

# 一、中断管理方法： #
	首先，对STM32中断进行分组，组0~4。同时，对每个中断设置一个抢占优先级和一个响应优先级值。
	分组配置是在寄存器SCB->AIRCR中配置：
	组	AIRCR[10：8] 	IP bit[7：4]分配情况	        分配结果
	0	    111         	  0：4	        0位抢占优先级，4位响应优先级
	1	    110	              1：3	        1位抢占优先级，3位响应优先级
	2	    101	              2：2	        2位抢占优先级，2位响应优先级
	3	    100	              3：1	        3位抢占优先级，1位响应优先级
	4	    011	              4：0	        4位抢占优先级，0位响应优先级
## STM32F103系列上面，有60个可屏蔽中断 ## 


![可屏蔽中断1](/images/单片机/stm32/NVIC中断优先级/可屏蔽中断1.png)

![可屏蔽中断2](/images/单片机/stm32/NVIC中断优先级/可屏蔽中断2.png)

## 抢占优先级 & 响应优先级区别： ##

**1、高优先级的抢占优先级是可以打断正在进行的低抢占优先级中断的。**

**2、抢占优先级相同的中断，高响应优先级不可以打断低响应优先级的中断。**

**3、抢占优先级相同的中断，当两个中断同时发生的情况下，哪个响应优先级高，哪个先执行。**

**4、如果两个中断的抢占优先级和响应优先级都是一样的话，则看哪个中断先发生就先执行；**



## 中断优先级分组函数：  ##

	void NVIC_PriorityGroupConfig(uint32_t NVIC_PriorityGroup);
	
	NVIC_PriorityGroupConfig(NVIC_PriorityGroup_2);


## 设置单个中断的抢占优先级和响应优先级 ##

	中断设置相关寄存器 
	_IO uint8_t  IP[240]; //中断优先级控制的寄存器组
	
	__IO uint32_t ISER[8]; //中断使能寄存器组
	__IO uint32_t ICER[8]; //中断失能寄存器组
	__IO uint32_t ISPR[8]; //中断挂起寄存器组
	__IO uint32_t ICPR[8]; //中断解挂寄存器组
	__IO uint32_t IABR[8]; //中断激活标志位寄存器组



# 二、中断寄存器介绍 #

## 中断优先级控制的寄存器组：IP[240]  ##


**全称是：Interrupt Priority Registers**

**240个8位寄存器，每个中断使用一个寄存器来确定优先级。STM32F10x系列一共60个可屏蔽中断，使用IP[59]~IP[0]。**

**每个IP寄存器的高4位用来设置抢占和响应优先级（根据分组），低4位没有用到。**


## 中断使能寄存器组：ISER[8] ##

**作用：用来使能中断**

**32位寄存器，每个位控制一个中断的使能。STM32F10x只有60个可屏蔽中断，所以只使用了其中的ISER[0]和ISER[1]。**

**ISER[0]的bit0~bit31分别对应中断0~31。ISER[1]的bit0~27对应中断32~59；**



## 中断失能寄存器组：ICER[8] ##

**作用：用来失能中断**

**32位寄存器，每个位控制一个中断的失能。STM32F10x只有60个可屏蔽中断，所以只使用了其中的ICER[0]和ICER[1]。**

**ICER[0]的bit0~bit31分别对应中断0~31。ICER[1]的bit0~27对应中断32~59；**

**配置方法跟ISER一样。**

## 中断挂起控制寄存器组：ISPR[8] ##

**作用：用来挂起中断**

## 中断解挂控制寄存器组：ICPR[8] ##

**作用：用来解挂中断**

	static __INLINE void NVIC_SetPendingIRQ(IRQn_Type IRQn)；
	static __INLINE uint32_t NVIC_GetPendingIRQ(IRQn_Type IRQn)；
	static __INLINE void NVIC_ClearPendingIRQ(IRQn_Type IRQn)


## 中断激活标志位寄存器组：IABR [8] ##

**作用：只读，通过它可以知道当前在执行的中断是哪一个,如果对应位为1，说明该中断正在执行。**

	static __INLINE uint32_t NVIC_GetActive(IRQn_Type IRQn)


# 三、中断参数初始化函数 #
	void NVIC_Init(NVIC_InitTypeDef* NVIC_InitStruct);

	typedef struct
	{
	  uint8_t NVIC_IRQChannel; //设置中断通道
	  uint8_t NVIC_IRQChannelPreemptionPriority;//设置响应优先级
	  uint8_t NVIC_IRQChannelSubPriority; //设置抢占优先级
	  FunctionalState NVIC_IRQChannelCmd; //使能/使能
	} NVIC_InitTypeDef;
	
	
	NVIC_InitTypeDef   NVIC_InitStructure;
	NVIC_InitStructure.NVIC_IRQChannel = USART1_IRQn;//串口1中断
	NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority=1 ;// 抢占优先级为1
	NVIC_InitStructure.NVIC_IRQChannelSubPriority = 2;// 子优先级位2
	NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;//IRQ通道使能
	NVIC_Init(&NVIC_InitStructure);	//根据上面指定的参数初始化NVIC寄存器


# 四、中断优先级设置步骤 #

	1、系统运行后先设置中断优先级分组。调用函数：
	void NVIC_PriorityGroupConfig(uint32_t NVIC_PriorityGroup);
	 整个系统执行过程中，只设置一次中断分组。
	2、针对每个中断，设置对应的抢占优先级和响应优先级：
	void NVIC_Init(NVIC_InitTypeDef* NVIC_InitStruct);
	3、如果需要挂起/解挂，查看中断当前激活状态，分别调用相关函数即可。
