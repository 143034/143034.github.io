---
title: 输入捕获
date: 2020-08-07 17:15:42
tags: 
- stm32
categories:
- 单片机
- stm32

---

# 一、介绍 #

**输入捕获工作过程**


![输入捕获工作过程](/images/单片机/stm32/输入捕获/输入捕获工作过程.png)





> 一句话总结工作过程：通过检测TIMx_CHx上的边沿信号，在边沿信号发生跳变（比如上升沿/下降沿）的时候，将当前定时器的值(TIMx_CNT)存放到对应的捕获/比较寄存器（TIMx_CCRx)里面，完成一次捕获。




**设置输入捕获滤波器**


![滤波](/images/单片机/stm32/输入捕获/滤波.png)



![滤波介绍](/images/单片机/stm32/输入捕获/滤波介绍.png)



**设置输入捕获极性**

![输入捕获极性获取](/images/单片机/stm32/输入捕获/输入捕获极性获取.png)

![输入捕获极性介绍](/images/单片机/stm32/输入捕获/输入捕获极性介绍.png)




**设置输入捕获映射通道**


![设置输入捕获映射通道](/images/单片机/stm32/输入捕获/设置输入捕获映射通道.png)

![设置输入捕获映射通道介绍](/images/单片机/stm32/输入捕获/设置输入捕获映射通道介绍.png)


**设置输入捕获分频器**


![设置输入捕获分频器](/images/单片机/stm32/输入捕获/设置输入捕获分频器.png)



![设置输入捕获分频器介绍](/images/单片机/stm32/输入捕获/设置输入捕获分频器介绍.png)



![设置输入捕获分频器介绍1](/images/单片机/stm32/输入捕获/设置输入捕获分频器介绍1.png)



**捕获到有效信号可以开启中断**



![中断使能寄存器](/images/单片机/stm32/输入捕获/中断使能寄存器.png)





# 二、输入捕获通道初始化函数： #

> void TIM_ICInit(TIM_TypeDef* TIMx, TIM_ICInitTypeDef* TIM_ICInitStruct);
	
	typedef struct
	{
	  uint16_t TIM_Channel; //捕获通道1-4   
	  uint16_t TIM_ICPolarity; //捕获极性
	  uint16_t TIM_ICSelection; //映射关系
	  uint16_t TIM_ICPrescaler; //分频系数
	  uint16_t TIM_ICFilter;  //滤波器
	} TIM_ICInitTypeDef;
	
	
	TIM5_ICInitStructure.TIM_Channel = TIM_Channel_1; TIM5_ICInitStructure.TIM_ICPolarity = TIM_ICPolarity_Rising;
	TIM5_ICInitStructure.TIM_ICSelection = TIM_ICSelection_DirectTI; 
	TIM5_ICInitStructure.TIM_ICPrescaler = TIM_ICPSC_DIV1;
	TIM5_ICInitStructure.TIM_ICFilter = 0x00;
	TIM_ICInit(TIM5, &TIM5_ICInitStructure);


## 通道极性设置独立函数： ##

> void TIM_OCxPolarityConfig(TIM_TypeDef* TIMx, uint16_t TIM_OCPolarity)；


## 获取通道捕获值 ##


> uint32_t TIM_GetCapture1(TIM_TypeDef* TIMx)；


# 三、输入捕获的一般配置步骤： #



- **初始化定时器和通道对应IO的时钟。** 

- **初始化IO口，模式为输入：GPIO_Init();**

    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IPD; //PA0 输入

- **初始化定时器ARR，PSC**

    TIM_TimeBaseInit();

- **初始化输入捕获通道**

    TIM_ICInit();

- **如果要开启捕获中断，**

    TIM_ITConfig();
    NVIC_Init();

- **使能定时器：TIM_Cmd();**

- **编写中断服务函数：TIMx_IRQHandler();**


# 四、代码: #


	TIM_ICInitTypeDef  TIM2_ICInitStructure;
	
	void TIM2_Cap_Init(u16 arr,u16 psc)
	{	 
		GPIO_InitTypeDef GPIO_InitStructure;
		TIM_TimeBaseInitTypeDef  TIM_TimeBaseStructure;
	 	NVIC_InitTypeDef NVIC_InitStructure;
	
		RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM2, ENABLE);
	
	    RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA, ENABLE); 
		
		GPIO_InitStructure.GPIO_Pin  = GPIO_Pin_0;  
		GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IPD; //输入
		GPIO_Init(GPIOA, &GPIO_InitStructure);
		GPIO_ResetBits(GPIOA,GPIO_Pin_0);						­
		
		 
		TIM_TimeBaseStructure.TIM_Period = arr; 
		TIM_TimeBaseStructure.TIM_Prescaler =psc; 	
		TIM_TimeBaseStructure.TIM_ClockDivision = TIM_CKD_DIV1; 
		TIM_TimeBaseStructure.TIM_CounterMode = TIM_CounterMode_Up;  
		TIM_TimeBaseInit(TIM2, &TIM_TimeBaseStructure); //定时器初始化

		TIM2_ICInitStructure.TIM_Channel = TIM_Channel_1; 
	  	TIM2_ICInitStructure.TIM_ICPolarity = TIM_ICPolarity_Rising;	
	  	TIM2_ICInitStructure.TIM_ICSelection = TIM_ICSelection_DirectTI; //映射到TI1上
	  	TIM2_ICInitStructure.TIM_ICPrescaler = TIM_ICPSC_DIV1;	 //不分频
	  	TIM2_ICInitStructure.TIM_ICFilter = 0x00;
	  	TIM_ICInit(TIM2, &TIM2_ICInitStructure);//输入捕获参数初始化
		
		NVIC_InitStructure.NVIC_IRQChannel = TIM2_IRQn;  
		NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 2;  
		NVIC_InitStructure.NVIC_IRQChannelSubPriority = 0;  
		NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE; 
		NVIC_Init(&NVIC_InitStructure);  //nvic中断向量
		
		TIM_ITConfig(TIM2,TIM_IT_Update|TIM_IT_CC1,ENABLE);//允许中断更新
		
	  TIM_Cmd(TIM2,ENABLE ); 	//定时器使能
	 
	}
	
	
	u8  TIM2CH1_CAPTURE_STA=0;		    				
	u16	TIM2CH1_CAPTURE_VAL;	
	 
	void TIM2_IRQHandler(void)//中断服务函数
	{
	
	
	}