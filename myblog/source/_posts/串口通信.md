---
title: 串口通信
date: 2020-09-17 09:41:45
tags:
- 52
categories:
- 单片机
- 52单片机

---

# 一、简介 #

> STC89C52系列单片机内部集成有一个功能很强的全双工串行通信口，与传统8051单片机的串口完全兼容。设有 2个互相独立的接收、发送缓冲器，可以同时发送和接收数据。发送缓冲器只能写入而不能读出，接收缓冲器只能读出而不能写入，，因而两个缓冲器可以共用一个地址码（99H）。两个缓冲器统称串行通信特殊功能寄存器SBUF。



串行通信设有**4种工作方式，其中两种方式的波特率是可变的，另两种是固定的**，以供不同应用场合选用。**波特率由内部定时器/计数器产生，用软件设置不同的波特率和选择不同的工作方式**。主机可通过查询或中断方式对接收/发送进行程序处理，使用十分灵活。


STC89C52系列单片机串行口对应的硬件部分对应的管脚是**P3.0/RxD和P3.1/TxD。**



# 二、串行口相关寄存器 #

![串口相关寄存器](/images/单片机/52单片机/串口通信/串口相关寄存器.png)

### 2.1、串行口控制寄存器SCON和PCON ###


STC89C52系列单片机的串行口设有两个控制寄存器：**串行控制寄存器SCON和波特率选择特殊功能寄存器PCON。**

![SCON寄存器](/images/单片机/52单片机/串口通信/SCON寄存器.png)

**SM0/FE**：当PCON寄存器中的SMOD0/PCON.6位为1时，该位用于帧错误检测。当检测到一个	无效停止位时，通过UART接收器设置该位。它必须由软件清零。当PCON寄存器中的SMOD0/PCON.6位为0时，该位和SM1一起指定串行通信的工作方式，如下表所示。

![串口工作方式选择](/images/单片机/52单片机/串口通信/串口工作方式选择.png)

**SM2**：允许方式2或方式3多机通信控制位。在方式2或方式3时，如SM2位为1，REN位为1，则从机处于只有接收到RB8位为1（地址帧）时才激活中断请求标志位RI为1，并向主机请求中断处理。被确认为寻址的丛机则复位SM2位为0，从而才接收RB8为0的数据帧。在方式1时，如果SM2位为1，则只有在接收到有效的停止位时才置位中断请求标志位RI为1；在方式0时，SM2 应为0。

**REN**：**允许/禁止串行接收控制位**。由软件置位REN，即REN=1为允许串行接收状态，可启动串行接收器RxD，开始接收信息。软件复位REN，即REN=0，则禁止接收。

**TB8**： **在方式2或方式3，它为要发送的第9位数据，按需要由软件置位或清0**。例如，可用作数据的校验位或多机通信中表示地址帧/数据帧的标志位。

**RB8**： **在方式2或方式3，是接收到的第9位数据**。在方式1，若SM2=0，则RB8是接收到的停止位。方式0不用RB8。

**TI**： **发送中断请求标志位**。在方式0，当串行发送数据第8位结束时，由内部硬件自动置位，即TI=1，向主机请求中断，响应中断后必须用软件复位，即TI=0。在其他方式中，则在停止位开始发送时由内部硬件置位，必须用软件复位。

**RI**： **接收中断请求标志位**。在方式0，当串行接收到第8位结束时由内部硬件自动置位RI=1， 向主机请求中断，响应中断后必须用软件复位，即RI=0。在其他方式中，串行接收到停止位的中间时刻由内部硬件置位，即RI=1（例外情况见SM2说明），必须由软件复位，即RI=0。


**SCON的所有位可通过整机复位信号复位为全“0”。SCON的字节地址尾98H，可位寻址，各位地址为98H~~9FH，可用软件实现位设置。**

**电源控制寄存器PCON中的SMOD/PCON.7用于设置方式1、方式2、方式3的波特率是否加倍。**


### 2.2、PCON:电源控制寄存器 (不可位寻址) ###

![PCON寄存器](/images/单片机/52单片机/串口通信/PCON寄存器.png)

**SMOD**：波特率选择位。当用软件置位SMOD，即SMOD=1，则使串行通信方式1、2、3的波特率加倍；SMOD=0，则各工作方式的波特率加倍。复位时SMOD=0。

**SMOD0**：帧错误检测有效控制位。当SMOD0=1，SCON寄存器中的SM0/FE位用于FE(帧错误检测)功能；当SMOD0=0，SCON寄存器中的SM0/FE位用于SM0功能,和SM1一起指定串行口的工作方式。复位时SMOD0=0



### 2.3、串行口数据缓冲寄存器SBUF ###


STC89C52系列单片机的串行口缓冲寄存器(SBUF)的地址是99H，实际是2个缓冲器，写SBUF的操作完成待发送数据的加载，读SBUF的操作可获得已接收到的数据。两个操作分别对应两个不同的寄存器，1个是只写寄存器，1个是只读寄存器。

串行通道内设有数据寄存器。在所有的串行通信方式中，在写入SBUF信号的控制下，把数据装入相同的9位移位寄存器，前面8位为数据字节，其最低位为移位寄存器的输出位。根据不同的工作方式会自动将“1”或TB8的值装入移位寄存器的第9位，并进行发送。


### 2.4、中断寄存器 ###

![中断寄存器](/images/单片机/52单片机/串口通信/中断寄存器.png)


![中断优先级寄存器](/images/单片机/52单片机/串口通信/中断优先级寄存器.png)



# 三、串行通信的中断请求 #

**当一帧发送完成，内部硬件自动置位TI，即TI=1，请求中断处理；当接收完一帧信息时，内部硬件自动置位RI，即RI=1，请求中断处理。由于TI和RI以“或逻辑”关系向主机请求中断，所以主机响应中断时事先并不知道是TI还是RI请求的中断，必须在中断服务程序中查询TI和RI进行判别，然后分别处理。因此，两个中断请求标志位均不能由硬件自动置位，必须通过软件清0，否则将出现一次请求多次响应的错误。**


# 四、工作模式 #


### 4.1、串行口工作模式0：同步移位寄存器 ###


**方式0时，串行口为同步移位寄存器的输入输出方式。主要用于扩展并行输入或输出口。数据由RXD（P3.0）引脚输入或输出，同步移位脉冲由TXD（P3.1）引脚输出。发送和接收均为8位数据，低位在先，高位在后。波特率固定为fosc/12。**

#### 方式0输出 ####

![方式0输出](/images/单片机/52单片机/串口通信/方式0输出.png)

#### 方式0输入 ####

![方式0输入](/images/单片机/52单片机/串口通信/方式0输入.png)

**模式0的发送过程**：当主机执行将数据写入发送缓冲器SBUF指令时启动发送，串行口即将8位数据以SYSclk/12或SYSclk/6的波特率从RxD管脚输出(从低位到高位)，发送完中断标志TI置"1"，TxD管脚输出同步移位脉冲（SHIFTCLOCK）。


**模式0接收过程**：模式0接收时，复位接收中断请求标志RI，即RI＝0，置位允许接收控制位REN=1时启动串行模式0接收过程。启动接收过程后，RxD为串行输入端，TxD为同步脉冲输出端。串行接收的波特率为SYSclk/12或SYSclk/6。

**当接收完成一帧数据(8位)后，控制信号复位，中断标志RI被置"1"，呈中断申请状态。当再次接收时，必须通过软件将RI清0**



### 4.2、串行口工作模式1：8位UART，波特率可变 ###

**方式1是10位数据的异步通信口。TXD为数据的发送引脚，RXD是数据的接受引脚。传送一帧数据的格式如图所示，其中1位起始位，8位数据位，1位停止位。**

![方式1数据位](/images/单片机/52单片机/串口通信/方式1数据位.png)

#### 方式1输出 ####

![方式1输出](/images/单片机/52单片机/串口通信/方式1输出.png)

#### 方式1输入 ####

![方式1输入](/images/单片机/52单片机/串口通信/方式1输入.png)

**串行通信模式1的波特率是可变的，可变的波特由定时器/计数器1或独立波特率发生器产生。**


	串行通信模式1的波特率=2^SMOD/32×(定时器/计数器1溢出率)
	当单片机工作在12T模式时，定时器1的溢出率 = SYSclk/12/( 256 - TH1)； 
	当单片机工作在6T模式时， 定时器1的溢出率 = SYSclk /6/ ( 256 - TH1)



### 4.3、方式2和方式3 ###

**方式2或方式3时，为11位数据的异步通信口，TXD为数据发送引脚，RXD为数据接收引脚。**

![方式2和3数据位](/images/单片机/52单片机/串口通信/方式2和3数据位.png)

**方式2、方式3，起始位1位、数据位9位（含附加的第九位，发送时为SCON中的TB8，接收时为SCON中的RB8）、停止位1位，一帧数据为11位。方式2的波特率固定为晶振频率的1/32或1/64。方式3的波特率由定时器T1的溢出率决定。**

#### 方式2、方式3的输出 ####

![方式2和3输出](/images/单片机/52单片机/串口通信/方式2和3输出.png)

#### 方式2、方式3的输入 ####

![方式2和3输入](/images/单片机/52单片机/串口通信/方式2和3输入.png)


# 五、波特率计算 #

![波特率计算](/images/单片机/52单片机/串口通信/波特率计算.png)