---
title: 独立看门狗
date: 2020-07-29 15:26:54
tags:
- stm32
categories:
- 单片机
- stm32

---
# 一、介绍 #


> 出于对单片机运行状态进行实时监测的考虑，便产生了一种专门用于监测单片机程序运行状态的模块或者芯片，俗称“看门狗”(watchdog) 。


## 看门狗解决的问题是什么？ ##

**在启动正常运行的时候，系统不能复位。**
**在系统跑飞（程序异常执行）的情况，系统复位，程序重新执行。**


	STM32内置两个看门狗，提供了更高的安全性，时间的精确性和使用的灵活性。两个看门狗设备（独立看门狗/窗口看门狗)可以用来检测和解决由软件错误引起的故障。当计数器达到给定的超时值时，触发一个中断（仅适用窗口看门狗）或者产生系统复位。
	独立看门狗（IWDG)由专用的低速时钟（LSI)驱动，即使主时钟发生故障它仍有效。
	
	独立看门狗适合应用于需要看门狗作为一个在主程序之外 能够完全独立工作，并且对时间精度要求低的场合。
	
	窗口看门狗由从APB1时钟分频后得到时钟驱动。通过可配置的时间窗口来检测应用程序非正常的过迟或过早操作。  
	窗口看门狗最适合那些要求看门狗在精确计时窗口起作用的程序。


## 独立看门狗功能描述 ##

**在键值寄存器（IWDG_KR)中写入0xCCCC，开始启用独立看门狗。此时计数器开始从其复位值0xFFF递减，当计数器值计数到尾值0x000时会产生一个复位信号（IWDG_RESET)。**

**无论何时，只要在键值寄存器IWDG_KR中写入0xAAAA（通常说的喂狗）, 自动重装载寄存器IWDG_RLR的值就会重新加载到计数器，从而避免看门狗复位。**

**如果程序异常，就无法正常喂狗，从而系统复位。**

# 二、寄存器介绍 #

![独立看门狗框图](/images/单片机/stm32/看门狗/独立看门狗框图.png)


	键值寄存器IWDG_KR: 0~15位有效
	预分频寄存器IWDG_PR：0~2位有效。具有写保护功能，要操作先取消写保护
	重装载寄存器IWDG_RLR：0~11位有效。具有写保护功能，要操作先取消写保护。
	状态寄存器IWDG_SR：0~1位有效

**键寄存器KR**

![键寄存器KR](/images/单片机/stm32/看门狗/键寄存器KR.png)


**预分频寄存器**

![预分频寄存器](/images/单片机/stm32/看门狗/预分频寄存器.png)

**重装载寄存器**

![重装载寄存器](/images/单片机/stm32/看门狗/重装载寄存器.png)

**状态寄存器**

![状态寄存器](/images/单片机/stm32/看门狗/状态寄存器.png)


**独立看门狗超时时间**

![看门狗超时时间](/images/单片机/stm32/看门狗/看门狗超时时间.png)


## 溢出时间计算： ##
	Tout=((4×2^prer) ×rlr) /40 （M3)
	时钟频率LSI=40K， 一个看门狗时钟周期就是最短超时时间。
	最长超时时间= (IWDG_RLR寄存器最大值）X看门狗时钟周期


## IWDG独立看门狗操作库函数 ##



**void IWDG_WriteAccessCmd(uint16_t IWDG_WriteAccess);//取消写保护：0x5555使能**

**void IWDG_SetPrescaler(uint8_t IWDG_Prescaler);//设置预分频系数：写PR**

**void IWDG_SetReload(uint16_t Reload);//设置重装载值：写RLR**

**void IWDG_ReloadCounter(void);//喂狗：写0xAAAA到KR**

**void IWDG_Enable(void);//使能看门狗：写0xCCCC到KR**

**FlagStatus IWDG_GetFlagStatus(uint16_t IWDG_FLAG);//状态：重装载/预分频 更新**



# 独立看门狗操作步骤 #

**1、取消寄存器写保护：**

    IWDG_WriteAccessCmd();

**2、设置独立看门狗的预分频系数，确定时钟:**

    IWDG_SetPrescaler();

**3、设置看门狗重装载值，确定溢出时间:**

    IWDG_SetReload();

**4、使能看门狗**

    IWDG_Enable();

**5、应用程序喂狗:**

    IWDG_ReloadCounter();

**6、溢出时间计算：**

    Tout=((4×2^prer) ×rlr) /40 （M3)



# 代码 #


	void IWDG_Init(u8 prer,u16 rlr) 
	{	
	 	IWDG_WriteAccessCmd(IWDG_WriteAccess_Enable);  
		
		IWDG_SetPrescaler(prer);  
		
		IWDG_SetReload(rlr);  
		
		IWDG_ReloadCounter(); 
		
		IWDG_Enable();  
	}
	
	void IWDG_Feed(void)
	{   
	 	IWDG_ReloadCounter();										   
	}